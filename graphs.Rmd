---
title: "Sports Analytics"
author: "Rasmus Säfvenberg & Sofie Jörgensen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(data.table)
library(minerva)
library(plotly)
```

# Read the data

```{r readData}
seasons <- c("0708", "0809", "0910", "1011", "1112", "1213", "1314")
assists <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/assist.csv", sep = "")), season) %>% 
        arrange(-Assists) %>% 
        mutate(Rank_trad = seq(1:nrow(.))) %>% # Create rank for traditional metric
        arrange(-weighted_assist) %>% 
        mutate(Rank_w = seq(1:nrow(.)), # Create rank for weighted metric
               Rank_diff = Rank_trad - Rank_w) # Rank difference
        ) %>% 
    rbindlist() %>% 
    rename(PlayerName = Playername,
           Metric_trad = Assists, 
           Metric_weight = weighted_assist) %>% 
    relocate(starts_with("Rank"), .before = PlayerId) # Change column order

goals <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/goal.csv", sep = "")),
    season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = Goals, 
           Metric_weight = Goals_w)

plusminus <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/plusminus.csv", sep = "")),
    season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = PlusMinus, 
           Metric_weight = PlusMinus_w)

points <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/point.csv", sep = "")),
    season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = Points, 
           Metric_weight = Points_w)

```

# Assists


```{r assists}
# Correlation between seasons
assists %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"), 
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_assists

stargazer(Corr_assists, summary = F, rownames = F)

# Correlation between players
# Oklart?
assists %>% 
  group_by(PlayerId) %>% 
  summarise(., AssistsSum = sum(Metric_trad), WAssistsSum = sum(Metric_weight)) %>% 
  summarise(., cor(AssistsSum, WAssistsSum))

# Assists vs weighted
assists %>% 
  ggplot(., aes(Metric_trad, Metric_weight)) + geom_point() + 
  geom_smooth(method = lm)

# Assists vs weighted per season
assists %>% 
  ggplot(., aes(Metric_trad, Metric_weight)) + geom_point() + 
  geom_smooth() + facet_wrap(~season)

# Histogram
assists %>% 
  ggplot(.) + geom_histogram(aes(Metric_trad), fill = "green", alpha = 0.5) + 
  geom_histogram(aes(Metric_weight), fill = "blue", alpha = 0.3)

# Get top n assisters overall
assists %>% 
  group_by(PlayerId) %>% 
  summarise(, AssistSum = sum(Metric_trad)) %>% 
  arrange(-AssistSum) %>% 
  head(10) %>% 
  pull(PlayerId) -> top10Assisters

# Split per player
assists %>% 
  filter(PlayerId %in% top10Assisters) %>% 
  ggplot(.) + 
  geom_point(aes(season, Metric_weight, group = PlayerId), color = "blue") + 
  geom_path(aes(season, Metric_weight, group = PlayerId), color = "blue") + 
  geom_point(aes(season, Metric_trad, group = PlayerId), color = "red") + 
  geom_path(aes(season, Metric_trad, group = PlayerId),color = "red") + 
  facet_wrap(~PlayerName)#+ geom_smooth(method = lm)

# All players in one (not great)
assists %>% 
  filter(PlayerId %in% top10Assisters) %>% 
  ggplot(.) + 
  geom_point(aes(season, Metric_weight, group = PlayerId, color = PlayerName)) + 
  geom_path(aes(season, Metric_weight, group = PlayerId, color = PlayerName)) + 
  geom_point(aes(season, Metric_trad, group = PlayerId, color = PlayerName)) + 
  geom_path(aes(season, Metric_trad, group = PlayerId, color = PlayerName))

# BARS
assists %>%
  group_by(season) %>% 
  slice_max(order_by = Metric_weight, n = 30) %>% 
  #head(30) %>% 
  arrange(-Rank_diff) %>% 
  ggplot(., aes(Rank_diff, reorder(PlayerName, -Rank_diff),
                fill = ifelse(Rank_diff > 0, "green", "red"))
         ) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~season, scales = "free")
#+  theme(axis.text.x = element_text(angle = 90)) #+ coord_flip()

# 
assists %>%
  group_by(season) %>% 
  slice_max(order_by = Metric_weight, n = 10) %>% 
  #head(30) %>% 
  arrange(-Rank_diff) %>% 
  ggplot(., aes(Rank_trad, Rank_w, color = Rank_diff,
                PlayerName = PlayerName)) + geom_point() + facet_wrap(~season) -> P 
ggplotly(P, tooltip = c("PlayerName", "Rank_trad", "Rank_w")) 

```

# Goals


```{r goals}
# Correlation between seasons
goals %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"),
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_goals

stargazer(Corr_goals, summary = F, rownames = F)
```


# PlusMinus


```{r plusminus}
# Correlation between seasons
plusminus %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"),
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_plusMinus

stargazer(Corr_plusMinus, summary = F, rownames = F)
```


# Points


```{r points}
# Correlation between seasons
points %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"),
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_points

stargazer(Corr_points, summary = F, rownames = F)
```
