---
title: "Sports Analytics"
author: "Rasmus Säfvenberg & Sofie Jörgensen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(data.table)
library(minerva)
library(plotly)
library(stargazer)
library(ggridges)
```

# Read the data

```{r readData}
seasons <- c("0708", "0809", "0910", "1011", "1112", "1213", "1314")
assists <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/assist.csv", sep = "")), season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = Assists, 
           Metric_weight = Assists_w) 

goals <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/goal.csv", sep = "")),  season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = Goals, 
           Metric_weight = Goals_w)

plusminus <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/plusminus.csv", sep = "")), season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = PlusMinus, 
           Metric_weight = PlusMinus_w)

points <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/point.csv", sep = "")), season)) %>% 
    rbindlist() %>% 
    rename(Metric_trad = Points, 
           Metric_weight = Points_w)

reward <- lapply(seasons, function(season) cbind(
    read.csv(paste(season, "/reward.csv", sep = "")), season)) %>% 
    rbindlist()
```

# Assists


```{r assists}
# Correlation between seasons
assists %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"), 
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_assists

stargazer(Corr_assists, summary = F, rownames = F)

# Correlation between players
# Oklart?
assists %>% 
  group_by(PlayerId) %>% 
  summarise(., AssistsSum = sum(Metric_trad), WAssistsSum = sum(Metric_weight)) %>% 
  summarise(., cor(AssistsSum, WAssistsSum))

# Assists vs weighted
assists %>% 
  ggplot(., aes(Metric_trad, Metric_weight)) + geom_point() + 
  geom_smooth(method = lm)

# Assists vs weighted per season
assists %>% 
  ggplot(., aes(Metric_trad, Metric_weight)) + geom_point() + 
  geom_smooth() + facet_wrap(~season)

# Histogram
assists %>% 
  ggplot(.) + geom_histogram(aes(Metric_trad), fill = "green", alpha = 0.5) + 
  geom_histogram(aes(Metric_weight), fill = "blue", alpha = 0.3)

# Get top n assisters overall
assists %>% 
  group_by(PlayerId) %>% 
  summarise(, AssistSum = sum(Metric_trad)) %>% 
  arrange(-AssistSum) %>% 
  head(10) %>% 
  pull(PlayerId) -> top10Assisters

# Split per player
assists %>% 
  filter(PlayerId %in% top10Assisters) %>% 
  ggplot(.) + 
  geom_point(aes(season, Metric_weight, group = PlayerId), color = "blue") + 
  geom_path(aes(season, Metric_weight, group = PlayerId), color = "blue") + 
  geom_point(aes(season, Metric_trad, group = PlayerId), color = "red") + 
  geom_path(aes(season, Metric_trad, group = PlayerId),color = "red") + 
  facet_wrap(~PlayerName)#+ geom_smooth(method = lm)

# All players in one (not great)
assists %>% 
  filter(PlayerId %in% top10Assisters) %>% 
  ggplot(.) + 
  geom_point(aes(season, Metric_weight, group = PlayerId, color = PlayerName)) + 
  geom_path(aes(season, Metric_weight, group = PlayerId, color = PlayerName)) + 
  geom_point(aes(season, Metric_trad, group = PlayerId, color = PlayerName)) + 
  geom_path(aes(season, Metric_trad, group = PlayerId, color = PlayerName))

# BARS
assists %>%
  group_by(season) %>% 
  slice_max(order_by = Metric_weight, n = 30) %>% 
  #head(30) %>% 
  arrange(-Rank_diff) %>% 
  ggplot(., aes(Rank_diff, reorder(PlayerName, -Rank_diff),
                fill = ifelse(Rank_diff > 0, "green", "red"))
         ) + 
  geom_bar(stat = "identity") + 
  facet_wrap(~season, scales = "free")
#+  theme(axis.text.x = element_text(angle = 90)) #+ coord_flip()

# 
assists %>%
  group_by(season) %>% 
  slice_max(order_by = Metric_weight, n = 10) %>% 
  #head(30) %>% 
  arrange(-Rank_diff) %>% 
  ggplot(., aes(Rank_trad, Rank_w, color = Rank_diff,
                PlayerName = PlayerName)) + geom_point() + facet_wrap(~season) -> P 
ggplotly(P, tooltip = c("PlayerName", "Rank_trad", "Rank_w")) 

```

# Goals


```{r goals}
# Correlation between seasons
goals %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"),
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_goals

stargazer(Corr_goals, summary = F, rownames = F)

goals %>% 
  mutate(rank = case_when(
    Rank_trad <= 30 ~ "top30",
    Rank_trad <= 100 ~ "top100",
    Rank_trad > 100 ~ "else",
    TRUE ~ as.character(Rank_trad)
    )) %>% 
  filter(Rank_trad <= 30) %>% 
  ggplot(., aes(Rank_trad, Rank_w, group = PlayerId, color = rank)) + geom_point() + 
  facet_wrap(~season, scales = "free") + geom_segment(aes(xend = Rank_trad, yend = Rank_w))

# Relative difference of rank difference and weighted rank
(points %>% 
  mutate(rel_diff = Rank_trad / Rank_w) %>% 
  mutate(rank = case_when(
    Rank_trad <= 10 ~ "top10",
    Rank_trad <= 30 ~ "top30",
    Rank_trad <= 100 ~ "top100",
    Rank_trad > 100 ~ "100 or worse",
    TRUE ~ as.character(Rank_trad)
  )) %>% 
  filter(season == "1314") %>% 
  #arrange(rel_diff) %>% 
  ggplot(.) + 
  #geom_point(aes(Rank_trad, log(rel_diff), PlayerName = PlayerName, color = rel_diff)) + 
  geom_point(aes(Rank_trad, rel_diff, PlayerName = PlayerName, Rank_w = Rank_w, color = rank)) ) %>% 
  ggplotly()#+ coord_flip()
  #select(PlayerName, Rank_trad, Rank_w, Rank_diff, rel_diff) 


newP <-points %>% 
  mutate(rel_diff = Rank_trad / Rank_w) %>% 
    pull(rel_diff)

clustering <- lapply(1:10, function(x) kmeans(newP, x))
C <- sapply(clustering, function(x) sum(x$withinss))
plot(1:10, C, type = "p")
lines(1:10, C)
sapply(2:10, function(x) C[x-1] / C[x]) 
C / cumsum(C)

(points %>% 
  mutate(rel_diff = Rank_trad / Rank_w, 
         cluster = factor(clustering[[3]]$cluster)) %>% 
  filter(season == "1314") %>% 
  #arrange(rel_diff) %>% 
  ggplot(.) + 
  #geom_point(aes(Rank_trad, log(rel_diff), PlayerName = PlayerName, color = rel_diff)) + 
  geom_point(aes(Rank_trad, rel_diff, 
                 PlayerName = PlayerName, Rank_w = Rank_w, color = cluster)) ) %>% 
  ggplotly()#+ coord_flip()
  #select(PlayerName, Rank_trad, Rank_w, Rank_diff, rel_diff) 

```


# PlusMinus


```{r plusminus}
# Correlation between seasons
plusminus %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"),
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_plusMinus

stargazer(Corr_plusMinus, summary = F, rownames = F)
```


# Points


```{r points}
# Correlation between seasons
points %>% 
  group_by(season) %>% 
  summarise(., Pearson = cor(Metric_trad, Metric_weight, method = "pearson"),
               Spearman = cor(Metric_trad, Metric_weight, method = "spearman"),
               MIC = mine(Metric_trad, Metric_weight)$MIC) %>%
  mutate(across(where(is.numeric), round, 3)) -> Corr_points

stargazer(Corr_points, summary = F, rownames = F)
```
# Reward
```{r reward}
reward %>% 
  mutate(GD_new = case_when(
    GD >= 5 ~ "5+",
    GD <= -5 ~ "-5+",
    TRUE ~ as.character(GD)
    )) -> reward

reward %>% 
  filter(TotalElapsedTime >= 0,  TotalElapsedTime <= 3600) %>% 
  ggplot(., aes(TotalElapsedTime, reward, color = GD)) + 
  geom_bin2d() + 
  facet_wrap(~season)

ggplot(reward, aes(x = GD, y = as.character(season), fill = stat(x))) +
  geom_density_ridges_gradient(scale = 1, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "Reward", option = "C") #+
  #geom_density_ridges() +
  #xlim(c(-2, 2))
  #facet_wrap(~season)

ggplot(reward, aes(x = reward, y = factor(GD, levels = sort(unique(GD))),
                   fill = stat(x))) +
  geom_density_ridges_gradient(scale = 1, rel_min_height = 0.01) +
  scale_fill_viridis_c(name = "Reward", option = "C") #+ xlim(c(-0.5, 1.5))

quantile(reward$reward, c(0.995))


reward %>% 
  filter(TotalElapsedTime >= 0, TotalElapsedTime <= 3600) %>% 
  ggplot(., aes(TotalElapsedTime, reward, color = GD)) + geom_point()


points %>%
  group_by(season) %>% 
  slice_max(order_by = Metric_weight, n = 30) %>% 
  ggplot(., aes(PlayerName, season, fill = Rank_diff)) + geom_tile()
```





